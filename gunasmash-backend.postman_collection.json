{
  "info": {
    "name": "GunaSmash",
    "_postman_id": "gunasmash-collection",
    "description": "Complete collection for Auth, Users (RBAC), Announcements, Blogs, and Uploads with auto-bearer, auto-refresh, factories, and tests.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Stats",
      "item": [
        {
          "name": "Global Stats",
          "request": {
            "method": "GET",
            "url": { "raw": "{{base_url}}/stats", "host": ["{{base_url}}"], "path": ["stats"] },
            "header": []
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('2xx/3xx', () => pm.expect(pm.response.code).to.be.within(200,399));",
                  "const j = pm.response.json();",
                  "pm.test('success', () => pm.expect(j.success).to.be.true);",
                  "pm.test('has users', () => pm.expect(j.data.users.total).to.be.a('number'));",
                  "pm.test('has blogs', () => pm.expect(j.data.blogs.total).to.be.a('number'));"
                ]
              }
            }
          ]
        },
        {
          "name": "Attendance Stats by Session",
          "request": {
            "method": "GET",
            "url": {
              "raw": "{{base_url}}/stats/attendance?announcementId={{announcement_id}}&date={{session_date}}",
              "host": ["{{base_url}}"],
              "path": ["stats", "attendance"],
              "query": [
                { "key": "announcementId", "value": "{{announcement_id}}" },
                { "key": "date", "value": "{{session_date}}" }
              ]
            },
            "header": []
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (!pm.environment.get('announcement_id')) {",
                  "  pm.expect.fail('announcement_id kosong. Jalankan Flow • Member Check-In atau Helper • Ensure AnnouncementId dulu.');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('2xx/3xx', () => pm.expect(pm.response.code).to.be.within(200,399));",
                  "const j = pm.response.json();",
                  "pm.test('success', () => pm.expect(j.success).to.be.true);",
                  "pm.test('counts shape', () => {",
                  "  pm.expect(j.data.counts).to.have.property('present');",
                  "  pm.expect(j.data.counts).to.have.property('late');",
                  "  pm.expect(j.data.counts).to.have.property('excused');",
                  "  pm.expect(j.data.counts).to.have.property('absent');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Auth",
      "item": [
        {
          "name": "Sign Up (random user)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{{payload}}"
            },
            "url": {
              "raw": "{{base_url}}/auth/sign-up",
              "host": ["{{base_url}}"],
              "path": ["auth", "sign-up"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "function rand(n){ return Math.random().toString(36).substring(2, 2+n); }",
                  "function nowSlug(){ return Date.now().toString(36); }",
                  "let fStr = pm.globals.get('factory_user');",
                  "let data;",
                  "try {",
                  "  const f = eval(fStr);",
                  "  data = (typeof f === 'function') ? f() : f;",
                  "} catch (e) {",
                  "const fallback = { name: 'User ' + rand(6), email: 'user+' + nowSlug() + '@example.com', password: 'password123' };",
                  "  data = fallback;",
                  "}",
                  "pm.variables.set('payload', JSON.stringify(data));"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const data = pm.response.json().data;",
                  "pm.environment.set('access_token', data.accessToken || data.access_token);",
                  "pm.environment.set('email', data.user.email);",
                  "pm.environment.set('user_id', data.user.id);",
                  "pm.test('user includes role', ()=> pm.expect(['ADMIN','MEMBER']).to.include(data.user.role));"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Sign In (admin)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{{payload}}"
            },
            "url": {
              "raw": "{{base_url}}/auth/sign-in",
              "host": ["{{base_url}}"],
              "path": ["auth", "sign-in"]
            },
            "description": "Sign in as seeded admin (Zidan). Uses env admin_email/admin_password or defaults."
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const email = pm.environment.get('admin_email') || 'zidanindratama03@gmail.com';",
                  "const password = pm.environment.get('admin_password') || 'password123';",
                  "pm.variables.set('payload', JSON.stringify({ email, password }));"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const data = pm.response.json().data;",
                  "pm.environment.set('access_token', data.accessToken || data.access_token);",
                  "pm.environment.set('admin_access_token', data.accessToken || data.access_token);",
                  "pm.environment.set('email', data.user.email);",
                  "pm.environment.set('user_id', data.user.id);",
                  "pm.test('role is ADMIN', ()=> pm.expect(data.user.role).to.equal('ADMIN'));"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Sign In",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"email\":\"{{email}}\",\"password\":\"{{password}}\"}"
            },
            "url": {
              "raw": "{{base_url}}/auth/sign-in",
              "host": ["{{base_url}}"],
              "path": ["auth", "sign-in"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const data = pm.response.json().data;",
                  "pm.environment.set('access_token', data.accessToken || data.access_token);",
                  "pm.test('access_token saved', ()=> pm.expect(pm.environment.get('access_token')).to.be.a('string').and.not.empty);"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Refresh Token",
          "request": {
            "method": "POST",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/auth/refresh",
              "host": ["{{base_url}}"],
              "path": ["auth", "refresh"]
            },
            "description": "Requires cookie jar to include refreshToken (set via sign-in/up)."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const data = pm.response.json().data;",
                  "if (data && (data.accessToken || data.access_token)) {",
                  "  pm.environment.set('access_token', data.accessToken || data.access_token);",
                  "}",
                  "pm.test('refreshed access token present', ()=> pm.expect(pm.environment.get('access_token')).to.be.a('string'));"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Me",
          "request": {
            "method": "GET",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/auth/me",
              "host": ["{{base_url}}"],
              "path": ["auth", "me"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const data = pm.response.json().data;",
                  "pm.environment.set('user_id', data.id);",
                  "pm.test('me has id/email/role', ()=> {",
                  "   pm.expect(data.id).to.be.a('string');",
                  "   pm.expect(data.email).to.include('@');",
                  "   pm.expect(['ADMIN','MEMBER']).to.include(data.role);",
                  "});"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Logout",
          "request": {
            "method": "DELETE",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/auth/logout",
              "host": ["{{base_url}}"],
              "path": ["auth", "logout"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);"
                ]
              }
            }
          ],
          "response": []
        }
      ]
    },
    {
      "name": "Users",
      "item": [
        {
          "name": "List users",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/users",
              "host": ["{{base_url}}"],
              "path": ["users"],
              "query": [
                { "key": "page", "value": "{{users_page}}" },
                { "key": "limit", "value": "{{users_limit}}" },
                { "key": "search", "value": "{{search_term}}" },
                { "key": "filter", "value": "{{users_filter}}" },
                { "key": "sort", "value": "{{users_sort}}" }
              ]
            },
            "description": "List users with optional search, filter (JSON), and sort (e.g. createdAt:desc)."
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// defaults so it tetap jalan walau env kosong",
                  "if (!pm.environment.get('users_page')) pm.environment.set('users_page', '1');",
                  "if (!pm.environment.get('users_limit')) pm.environment.set('users_limit', '10');",
                  "if (pm.environment.get('search_term') === undefined) pm.environment.set('search_term', '');",
                  "if (pm.environment.get('users_filter') === undefined) pm.environment.set('users_filter', '');",
                  "if (pm.environment.get('users_sort') === undefined) pm.environment.set('users_sort', '');"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const data = json.data;",
                  "pm.test('data.items array', ()=> pm.expect(Array.isArray(data.items)).to.be.true);",
                  "const firstId = data?.items?.[0]?.id || data?.items?.[0]?._id;",
                  "if (firstId) pm.environment.set('member_id', firstId);",
                  "",
                  "// Optional: validate filter role if provided",
                  "const filterStr = pm.environment.get('users_filter');",
                  "if (filterStr) {",
                  "  try {",
                  "    const f = JSON.parse(filterStr);",
                  "    if (f.role && typeof f.role === 'string') {",
                  "      pm.test('all items match role filter', ()=> {",
                  "        data.items.forEach(u => pm.expect(u.role).to.equal(f.role));",
                  "      });",
                  "    }",
                  "  } catch(e) {}",
                  "}"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Get user by id",
          "request": {
            "method": "GET",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/users/{{member_id}}",
              "host": ["{{base_url}}"],
              "path": ["users", "{{member_id}}"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Promote/Demote role",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"role\":\"ADMIN\"}"
            },
            "url": {
              "raw": "{{base_url}}/users/{{member_id}}/role",
              "host": ["{{base_url}}"],
              "path": ["users", "{{member_id}}", "role"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "pm.test('role is ADMIN', ()=> pm.expect(pm.response.json().data.role).to.equal('ADMIN'));"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Delete user",
          "request": {
            "method": "DELETE",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/users/{{member_id}}",
              "host": ["{{base_url}}"],
              "path": ["users", "{{member_id}}"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Import CSV (file)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": ["./members.csv"]
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/users/import",
              "host": ["{{base_url}}"],
              "path": ["users", "import"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);"
                ]
              }
            }
          ]
        },
        {
          "name": "Export CSV",
          "request": {
            "method": "GET",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/users/export/csv",
              "host": ["{{base_url}}"],
              "path": ["users", "export", "csv"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200', ()=> pm.expect(pm.response.code).to.equal(200));",
                  "pm.test('CSV content-type', ()=> pm.expect(pm.response.headers.get('Content-Type')).to.include('text/csv'));"
                ]
              }
            }
          ],
          "response": []
        }
      ]
    },
    {
      "name": "Announcements",
      "item": [
        {
          "name": "Create announcement",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{{payload}}" },
            "url": {
              "raw": "{{base_url}}/announcements",
              "host": ["{{base_url}}"],
              "path": ["announcements"]
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "function safeEvalFactory(src){",
                  "  try{ const f = eval(src); return (typeof f==='function')?f():f; }",
                  "  catch(e){ return null; }",
                  "}",
                  "const fStr = pm.collectionVariables.get('factory_announcement');",
                  "let data = safeEvalFactory(fStr);",
                  "if(!data){",
                  "  data = {",
                  "    day: 'Rabu',",
                  "    time: '15.00–18.00',",
                  "    location: 'Test Sport Center Kampus H',",
                  "    locationLink: 'https://www.google.com/maps/search/?api=1&query=Sport%20Center%20Kampus%20H',",
                  "    imageUrl: null",
                  "  };",
                  "}",
                  "pm.variables.set('payload', JSON.stringify(data));"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json();",
                  "pm.test('success true', ()=> pm.expect(json.success).to.be.true);",
                  "const item = json.data;",
                  "pm.environment.set('announcement_id', item.id || item._id);",
                  "pm.test('stored id', ()=> pm.expect(pm.environment.get('announcement_id')).to.be.a('string'));"
                ]
              }
            }
          ]
        },
        {
          "name": "List announcements",
          "request": {
            "method": "GET",
            "url": {
              "raw": "{{base_url}}/announcements?page=1&limit=5&search={{search_term}}",
              "host": ["{{base_url}}"],
              "path": ["announcements"],
              "query": [
                { "key": "page", "value": "1" },
                { "key": "limit", "value": "5" },
                { "key": "search", "value": "{{search_term}}" }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json();",
                  "pm.test('success true', ()=> pm.expect(json.success).to.be.true);",
                  "const items = json.data?.items || [];",
                  "pm.test('items array', ()=> pm.expect(Array.isArray(items)).to.be.true);",
                  "const id = items[0]?.id || items[0]?._id;",
                  "if(id) pm.environment.set('announcement_id', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Get announcement by id",
          "request": {
            "method": "GET",
            "url": {
              "raw": "{{base_url}}/announcements/{{announcement_id}}",
              "host": ["{{base_url}}"],
              "path": ["announcements", "{{announcement_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json();",
                  "pm.test('success true', ()=> pm.expect(json.success).to.be.true);",
                  "pm.test('has fields', ()=> {",
                  "  const a = json.data;",
                  "  pm.expect(a).to.have.property('day');",
                  "  pm.expect(a).to.have.property('time');",
                  "  pm.expect(a).to.have.property('location');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update announcement",
          "request": {
            "method": "PATCH",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\"location\":\"Updated {{ts}} Hall\"}" },
            "url": {
              "raw": "{{base_url}}/announcements/{{announcement_id}}",
              "host": ["{{base_url}}"],
              "path": ["announcements", "{{announcement_id}}"]
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": ["pm.variables.set('ts', Date.now().toString(36));"]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json();",
                  "pm.test('success true', ()=> pm.expect(json.success).to.be.true);",
                  "pm.test('location updated', ()=> pm.expect(json.data.location).to.include('Updated'));"
                ]
              }
            }
          ]
        },
        {
          "name": "Delete announcement",
          "request": {
            "method": "DELETE",
            "url": {
              "raw": "{{base_url}}/announcements/{{announcement_id}}",
              "host": ["{{base_url}}"],
              "path": ["announcements", "{{announcement_id}}"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json();",
                  "pm.test('success true', ()=> pm.expect(json.success).to.be.true);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Attendance",
      "item": [
        {
          "name": "Member Check-In",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\"announcementId\":\"{{announcement_id}}\",\"note\":\"Hadir {{NOW}}\"}"
            },
            "url": {
              "raw": "{{base_url}}/attendance/check-in",
              "host": ["{{base_url}}"],
              "path": ["attendance", "check-in"]
            },
            "description": "Requires a valid {{announcement_id}}. Works for role MEMBER or ADMIN."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('2xx/3xx', () => pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json();",
                  "pm.test('success', () => pm.expect(json.success).to.be.true);",
                  "const s = json.data.session;",
                  "if (s?.date) {",
                  "  const d = new Date(s.date);",
                  "  const y = d.getFullYear();",
                  "  const m = String(d.getMonth()+1).padStart(2,'0');",
                  "  const dd = String(d.getDate()).padStart(2,'0');",
                  "  pm.environment.set('session_date', `${y}-${m}-${dd}`);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Check-In (pick a member)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{admin_access_token}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"announcementId\":\"{{announcement_id}}\",\"userId\":\"{{member_id}}\",\"status\":\"PRESENT\",\"note\":\"Admin mark {{NOW}}\"}"
            },
            "url": {
              "raw": "{{base_url}}/attendance/admin/check-in",
              "host": ["{{base_url}}"],
              "path": ["attendance", "admin", "check-in"]
            },
            "description": "Requires ADMIN."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('2xx/3xx', () => pm.expect(pm.response.code).to.be.within(200,399));",
                  "const j = pm.response.json();",
                  "pm.test('success', () => pm.expect(j.success).to.be.true);",
                  "pm.test('status valid', () => pm.expect(j.data.attendance.status).to.be.oneOf(['PRESENT','LATE','EXCUSED','ABSENT']));",
                  "const s=j.data.session;",
                  "if(s?.date){ const d=new Date(s.date); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); pm.environment.set('session_date', `${y}-${m}-${dd}`); }"
                ]
              }
            }
          ]
        },
        {
          "name": "Session Summary (today or {{session_date}})",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/attendance/session/summary?announcementId={{announcement_id}}&date={{session_date}}",
              "host": ["{{base_url}}"],
              "path": ["attendance", "session", "summary"],
              "query": [
                { "key": "announcementId", "value": "{{announcement_id}}" },
                { "key": "date", "value": "{{session_date}}" }
              ]
            },
            "description": "If {{session_date}} empty, backend may resolve today’s session."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('2xx/3xx', () => pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json();",
                  "pm.test('success', () => pm.expect(json.success).to.be.true);",
                  "const d = json.data;",
                  "pm.test('counts ok', () => {",
                  "  pm.expect(d.counts).to.have.property('totalMembers');",
                  "  pm.expect(d.counts).to.have.property('present');",
                  "  pm.expect(d.counts).to.have.property('absent');",
                  "});",
                  "pm.test('arrays ok', () => {",
                  "  pm.expect(Array.isArray(d.presentUsers)).to.be.true;",
                  "  pm.expect(Array.isArray(d.absentUsers)).to.be.true;",
                  "});",
                  "if (d.session && d.session.date){",
                  "  const x = new Date(d.session.date);",
                  "  const y = x.getFullYear();",
                  "  const m = String(x.getMonth()+1).padStart(2,'0');",
                  "  const dd = String(x.getDate()).padStart(2,'0');",
                  "  pm.environment.set('session_date', `${y}-${m}-${dd}`);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Export Session CSV",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/attendance/session/export?announcementId={{announcement_id}}&date={{session_date}}",
              "host": ["{{base_url}}"],
              "path": ["attendance", "session", "export"],
              "query": [
                { "key": "announcementId", "value": "{{announcement_id}}" },
                { "key": "date", "value": "{{session_date}}" }
              ]
            },
            "description": "Downloads CSV of present/absent users for the session."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200', () => pm.expect(pm.response.code).to.equal(200));",
                  "pm.test('CSV content-type', () => pm.expect(pm.response.headers.get('Content-Type')).to.include('text/csv'));",
                  "pm.test('has header row', () => pm.expect(pm.response.text()).to.match(/^type,name,email\\n/));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Blogs",
      "item": [
        {
          "name": "Create blog",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{{payload}}"
            },
            "url": {
              "raw": "{{base_url}}/blogs",
              "host": ["{{base_url}}"],
              "path": ["blogs"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "function rand(n){ return Math.random().toString(36).substring(2, 2+n); }",
                  "function nowSlug(){ return Date.now().toString(36); }",
                  "let fStr = pm.globals.get('factory_blog');",
                  "let data;",
                  "try {",
                  "  const f = eval(fStr);",
                  "  data = (typeof f === 'function') ? f() : f;",
                  "} catch (e) {",
                  "const fallback = { title: 'Blog ' + rand(6), slug: 'blog-' + nowSlug() + '-' + rand(4), content: 'Markdown **content** generated at ' + new Date().toISOString(), coverUrl: null, tags: ['news','update'], published: false };",
                  "  data = fallback;",
                  "}",
                  "pm.variables.set('payload', JSON.stringify(data));"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const item = pm.response.json().data;",
                  "pm.environment.set('blog_id', item.id || item._id);",
                  "pm.test('stored blog_id', ()=> pm.expect(pm.environment.get('blog_id')).to.be.a('string'));"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "List blogs",
          "request": {
            "method": "GET",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/blogs?page=1&limit=5&search={{search_term}}",
              "host": ["{{base_url}}"],
              "path": ["blogs?page=1&limit=5&search={{search_term}}"],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "5"
                },
                {
                  "key": "search",
                  "value": "{{search_term}}"
                }
              ]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const data = pm.response.json().data;",
                  "const id = data?.items?.[0]?.id || data?.items?.[0]?._id;",
                  "if (id) pm.environment.set('blog_id', id);",
                  "pm.test('listed blogs and maybe stored id', ()=> pm.expect(Array.isArray(data.items)).to.be.true);"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Get blog by id",
          "request": {
            "method": "GET",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/blogs/{{blog_id}}",
              "host": ["{{base_url}}"],
              "path": ["blogs", "{{blog_id}}"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Update blog",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\"title\":\"Updated Blog {{RANDOM}}\",\"published\":true}"
            },
            "url": {
              "raw": "{{base_url}}/blogs/{{blog_id}}",
              "host": ["{{base_url}}"],
              "path": ["blogs", "{{blog_id}}"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const d = pm.response.json().data;",
                  "pm.test('published true', ()=> pm.expect(d.published).to.be.true);"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Delete blog",
          "request": {
            "method": "DELETE",
            "header": [],
            "body": {},
            "url": {
              "raw": "{{base_url}}/blogs/{{blog_id}}",
              "host": ["{{base_url}}"],
              "path": ["blogs", "{{blog_id}}"]
            },
            "description": ""
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);"
                ]
              }
            }
          ],
          "response": []
        }
      ]
    },
    {
      "name": "Uploads",
      "item": [
        {
          "name": "Upload image (form-data)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": ["./sample.jpg"]
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/uploads/image",
              "host": ["{{base_url}}"],
              "path": ["uploads", "image"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('HTTP 2xx/3xx', ()=> pm.expect(pm.response.code).to.be.within(200,399));",
                  "const json = pm.response.json ? pm.response.json() : null;",
                  "pm.test('success flag true', ()=> pm.expect(json && json.success).to.be.true);",
                  "const d = pm.response.json().data;",
                  "pm.test('has url', ()=> pm.expect(d.url).to.be.a('string'));"
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "/* ===== Collection Pre-request: helpers, factories, auto-bearer ===== */",
          "const env = pm.environment;",
          "",
          "// attach bearer automatically (skip for sign-in/up/refresh)",
          "const path = pm.request.url.getPath();",
          "const skipAuth = /\\/auth\\/(sign-in|sign-up|refresh)/.test(path);",
          "const token = env.get('access_token');",
          "if (!skipAuth && token) {",
          "  pm.request.headers.upsert({ key: 'Authorization', value: 'Bearer ' + token });",
          "}",
          "",
          "// Factories for random payloads",
          "function rand(n){return Math.random().toString(36).substring(2,2+n);}",
          "function nowSlug(){return Date.now().toString(36);}",
          "pm.variables.set('RANDOM', rand(8));",
          "pm.variables.set('NOW', nowSlug());",
          "",
          "pm.globals.set('factory_user', (()=>({",
          "  name: 'User ' + rand(6),",
          "  email: 'user+' + nowSlug() + '@example.com',",
          "  password: 'password123'",
          "})).toString());",
          "",
          "pm.globals.set('factory_announcement', (()=>({",
          "  title: 'Announcement ' + rand(6),",
          "  content: 'This is a seeded announcement at ' + new Date().toISOString(),",
          "  coverUrl: null",
          "})).toString());",
          "",
          "pm.globals.set('factory_blog', (()=>({",
          "  title: 'Blog ' + rand(6),",
          "  slug: 'blog-' + nowSlug() + '-' + rand(4),",
          "  content: 'Markdown **content** generated at ' + new Date().toISOString(),",
          "  coverUrl: null,",
          "  tags: ['news','update'],",
          "  published: false",
          "})).toString());"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "/* ===== Collection Tests: auto-refresh on 401, then retry once ===== */",
          "const env = pm.environment;",
          "const path = pm.request.url.getPath();",
          "const isAuth = /\\/auth\\/(sign-in|sign-up|refresh)/.test(path);",
          "if (pm.response.code === 401 && !isAuth) {",
          "  const tried = env.get('retry_once');",
          "  if (!tried) {",
          "    env.set('retry_once', '1');",
          "    // trigger refresh",
          "    const refreshUrl = pm.environment.get('base_url') + '/auth/refresh';",
          "    pm.sendRequest({ url: refreshUrl, method: 'POST' }, (err, res) => {",
          "      if (!err && res.code === 200) {",
          "        try {",
          "          const json = res.json();",
          "          const t = json?.data?.accessToken || json?.data?.access_token;",
          "          if (t) env.set('access_token', t);",
          "        } catch(e) {}",
          "        // retry same request",
          "        postman.setNextRequest(pm.info.requestName);",
          "      }",
          "    });",
          "  } else {",
          "    env.unset('retry_once');",
          "  }",
          "} else {",
          "  env.unset('retry_once');",
          "}"
        ]
      }
    }
  ]
}
