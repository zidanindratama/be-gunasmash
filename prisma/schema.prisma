generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEMBER
}

enum AttendanceStatus {
  PRESENT
  LATE
  EXCUSED
  ABSENT
}

enum SessionState {
  OPEN
  CLOSED
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  name      String
  password  String
  role      Role     @default(MEMBER)
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  announcements Announcement[]
  blogs         Blog[]
  attendances   Attendance[]
}

model Announcement {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  day          String
  time         String
  location     String
  locationLink String?
  imageUrl     String?
  createdBy    String   @db.ObjectId
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  author   User               @relation(fields: [createdBy], references: [id])
  sessions AttendanceSession[]

  @@index([day])
}

model Blog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  slug      String   @unique
  content   String
  coverUrl  String?
  tags      String[]
  createdBy String   @db.ObjectId
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User @relation(fields: [createdBy], references: [id])
}

model AttendanceSession {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  announcementId String       @db.ObjectId
  date           DateTime
  state          SessionState @default(OPEN)
  openedAt       DateTime?
  closedAt       DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  announcement Announcement @relation(fields: [announcementId], references: [id])
  items        Attendance[]

  @@unique([announcementId, date], name: "announcementId_date")
}

model Attendance {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  sessionId String           @db.ObjectId
  userId    String           @db.ObjectId
  status    AttendanceStatus @default(PRESENT)
  note      String?
  createdAt DateTime         @default(now())

  session AttendanceSession @relation(fields: [sessionId], references: [id])
  user    User             @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId], name: "sessionId_userId")
}
